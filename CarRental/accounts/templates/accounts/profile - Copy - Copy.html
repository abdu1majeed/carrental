{% extends 'base.html' %}
{% load static %}

{% block title %}Account Management | {{ user.first_name|default:user.username }}{% endblock %}

<style>
    /* ------------------ COLOR SYSTEM ------------------ */

    :root {
        --primary: #00a877;        /* Emerald Green */
        --primary-dark: #00875e;
        --bg-light: #f5f7fa;       /* Soft background */
        --text-dark: #1f2937;      /* Dark Slate */
        --text-muted: #6b7280;     /* Muted Gray */
        --card-border: #e5e7eb;    /* Light border */
        --blue-accent: #2563eb;    /* Modern Blue */
        --danger: #dc3545;
        --warning: #facc15;
    }

    /* Global */
    body {
        background-color: var(--bg-light) !important;
        color: var(--text-dark) !important;
    }

    h2, h4, h5, h6 {
        color: var(--text-dark) !important;
    }

    p, small, label {
        color: var(--text-muted) !important;
    }

    /* Primary items */
    .text-primary {
        color: var(--primary) !important;
    }
    .badge.bg-primary {
        background-color: var(--primary) !important;
    }
    .btn-primary {
        background-color: var(--primary) !important;
        border-color: var(--primary) !important;
    }
    .btn-primary:hover {
        background-color: var(--primary-dark) !important;
    }

    /* Success button override */
    .btn-success {
        background-color: var(--primary) !important;
        border-color: var(--primary) !important;
    }
    .btn-success:hover {
        background-color: var(--primary-dark) !important;
        border-color: var(--primary-dark) !important;
    }

    /* Tabs */
    .nav-tabs {
        background: white !important;
        border-bottom: 1px solid var(--card-border);
    }
    .nav-link {
        color: var(--text-muted) !important;
        font-weight: 600;
    }
    .nav-link.active {
        color: var(--primary) !important;
        border-bottom: 3px solid var(--primary) !important;
        background-color: white !important;
    }

    /* Cards */
    .card {
        background: #ffffff !important;
        border: 1px solid var(--card-border);
        box-shadow: 0 6px 20px rgba(0,0,0,0.05);
        border-radius: 12px;
    }

    /* Booking card left-border colors */
    .border-primary { border-left: 6px solid var(--primary) !important; }
    .border-success { border-left: 6px solid #16a34a !important; }
    .border-info    { border-left: 6px solid var(--blue-accent) !important; }
    .border-danger  { border-left: 6px solid var(--danger) !important; }
    .border-secondary { border-left: 6px solid #9ca3af !important; }

    /* Badges (status indicators) */
    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }

    .badge.bg-success   { background-color: #16a34a !important; }
    .badge.bg-info      { background-color: var(--blue-accent) !important; }
    .badge.bg-secondary { background-color: #9ca3af !important; }
    .badge.bg-danger    { background-color: var(--danger) !important; }

</style>

{% block content %}
<div class="container my-5 pt-5 profile-page">
    <h2 class="fw-bold mb-4 text-center"><i class="fas fa-user-cog me-2 text-primary"></i> Account Management</h2>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                
                <div class="card-header p-0">
                    <ul class="nav nav-tabs nav-fill rounded-top-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings-tab-pane" type="button" role="tab">
                                <i class="fas fa-history me-1 text-primary"> My Bookings</i> 
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-tab-pane" type="button" role="tab">
                                <i class="fas fa-user-edit me-1 text-primary"> Edit Details</i>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents-tab-pane" type="button" role="tab">
                                <i class="fas fa-file-alt me-1 text-primary"> ID & License</i>
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="card-body p-4">
                    <div class="tab-content" id="profileTabsContent">
                        
                        <div class="tab-pane fade show active" id="bookings-tab-pane" role="tabpanel">
                            <h4 class="fw-bold text-primary mb-4">List of Recent Bookings</h4>

                            {% if bookings %}
                                {% for booking in bookings %}
                                    
                                    <div class="card mb-3 shadow-sm 
                                        {% if booking.status == 'PENDING' %}border-primary
                                        {% elif booking.status == 'CONFIRMED' %}border-success
                                        {% elif booking.status == 'ACTIVE' %}border-info
                                        {% elif booking.status == 'COMPLETED' %}border-secondary
                                        {% elif booking.status == 'CANCELLED' %}border-danger
                                        {% else %}border-secondary
                                        {% endif %}">
                                        
                                        <div class="card-body">
                                            <div class="row align-items-center">

                                                <div class="col-md-6 text-md-start mb-3 mb-md-0">
                                                    <h5 class="fw-bold mb-1">{{ booking.car.brand }} {{ booking.car.model_name }}</h5>
                                                    <p class="text-muted small mb-1">
                                                        {{ booking.start_date|date:"Y-m-d" }} to {{ booking.end_date|date:"Y-m-d" }}
                                                        (Duration: {{ booking.duration_days }} days)
                                                    </p>
                                                </div>

                                                <div class="col-md-6 text-md-start mt-3 mt-md-0">
                                                    <h4 class="text-primary fw-bold mb-1">
                                                        {{ booking.total_price }} SAR
                                                    </h4>

                                                    {% if booking.status == 'PENDING' %}
                                                        <span class="badge bg-primary rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'CONFIRMED' %}
                                                        <span class="badge bg-success rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'ACTIVE' %}
                                                        <span class="badge bg-info rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'COMPLETED' %}
                                                        <span class="badge bg-secondary rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'CANCELLED' %}
                                                        <span class="badge bg-danger rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% endif %}

                                                    {% if booking.status == 'PENDING' %}
                                                        <small class="d-block text-muted">
                                                            Pending admin review
                                                        </small>
                                                    {% endif %}
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info text-center" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    You have no bookings yet.
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="tab-pane fade" id="settings-tab-pane" role="tabpanel">
                            <h4 class="fw-bold text-primary mb-4">Update Account Details</h4>

                            <form method="POST" action="{% url 'accounts:update_profile' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ user_form.first_name.label }}</label>
                                        {{ user_form.first_name }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ user_form.email.label }}</label>
                                        {{ user_form.email }}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ profile_form.phone_number.label }}</label>
                                        {{ profile_form.phone_number }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ profile_form.date_of_birth.label }}</label>
                                        {{ profile_form.date_of_birth }}
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success mt-4 w-100"><i class="fas fa-save me-2"></i> Save Changes</button>
                            </form>
                            
                            <hr class="my-5">

                            <div class="text-center">
                                <h5 class="text-danger fw-bold">Permanently Delete Account</h5>
                                <p class="text-muted small">
                                    This action will permanently delete all your data and bookings from the system. This cannot be undone.
                                </p>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                    <i class="fas fa-trash me-2"></i> Delete Account
                                </button>
                            </div>

                        </div>

                        <div class="tab-pane fade" id="documents-tab-pane" role="tabpanel">
                            <h4 class="fw-bold text-primary mb-4">Add & Update Required Documents</h4>

                            {% if profile_instance.has_required_documents %}
                                <div class="alert alert-success text-center" role="alert">
                                    <i class="fas fa-check-circle me-2"></i> All required documents are uploaded!
                                </div>
                            {% else %}
                                <div class="alert alert-warning text-center" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i> Please upload your National ID/Residency and Driving License to complete your booking.
                                </div>
                            {% endif %}

                            <form method="POST" action="{% url 'accounts:update_profile' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <h6 class="fw-bold mt-4">1. National ID / Residency Image</h6>
                                {{ profile_form.national_id_image }}
                                {% if profile_instance.national_id_image %}
                                    <small class="text-success d-block mt-1">
                                        <i class="fas fa-file-image me-1"></i> Current file uploaded.
                                    </small>
                                {% endif %}
                                
                                <h6 class="fw-bold mt-4">2. Driving License Image</h6>
                                {{ profile_form.driving_license_image }}
                                {% if profile_instance.driving_license_image %}
                                    <small class="text-success d-block mt-1">
                                        <i class="fas fa-file-image me-1"></i> Current file uploaded.
                                    </small>
                                {% endif %}

                                <button type="submit" class="btn btn-primary btn-lg mt-5 w-100"><i class="fas fa-upload me-2"></i> Update Documents</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Confirm Account Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to permanently delete your account? This action cannot be undone.</p>
                <small class="text-danger fw-bold">All your bookings and data will be deleted.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{% url 'accounts:delete_account' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger"><i class="fas fa-trash-alt me-2"></i> Confirm Deletion</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}